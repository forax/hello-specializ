# hello-specializ
A prototype of type specialization for Java 10

The prototype is composed of two files:
 - Dumper, that uses ASM to create create three java classes,
   ArrayList which is a prototype of a specializable ArrayList, Test that tests the ArrayList<Object>
   and Test2 that tests the ArrayList<long>.
 - SpecializMetaFactory which contains the bootstrap methods that does the bridging between the code
   and a variant (a specialization) of the specializable class.
   - indy creates the different variants of the specializable class on the fly and redirect call
     to the variant class to the right variant
   - bsm that implement the operation that are allowed on variable of type 'any' or array of 'any'
     (things like equals, arrayNewInstance, arrayGet, etc)
     
The prototype is based on several ideas
  - class like ArrayList<int> are not denotable directly in bytecode, i.e. there is no classloader
    that stores a representation of ArrayList<int> that why every methods of ArrayList<int>
    must be accessed using invokedynamic.
  - the specialization is done by patching several constant pool entries (practically there are all
    grouped together at the start of the constant pool) so there is no bytecode rewriting at runtime :)
  - while specializing instruction like getfield or invokedynamic is easy because these opcodes
    use the constant pool, it's harder for opcodes like aload, iload or freturn.
    Here, i use a trick, i generate a cascade of if/else that tests what is the current variant
    and do the appropriate variant of load, store or return. This bytecode is not safe, but who cares :)

If you are curious about what the u-opcodes are, you can look at this video
  https://www.youtube.com/watch?v=SPhJs4KpJBM
If you found that the last part use too many interfaces, you are not alone !

## How to compile it
Just compiles the two files (with ASM as a dependency for Dumper.java)
```
javac -d classes/ -classpath lib/asm-all-5.0.4.jar src/specializ/Dumper.java 
javac -d classes/ src/specializ/java/util/SpecializMetaFactory.java
```
Note: you will see warnings because SpecializMetaFactory use Unsafe.createAnonymousClass,
don't worry it's Ok !

## How to run it
First, you have to generate the 3 classes, ArrayList, Test and Test2 by running the Dumper that uses ASM

```
java -cp classes:lib/asm-all-5.0.4.jar specializ.Dumper
``` 
the classes will be generated in the folder 'classes'.

then you can run the two tests like this
```
java -noverify -cp classes specializ/Test
```
or
```
java -noverify -cp classes specializ/Test2
```

Note that you need '-noverify' because the generated bytecodes corresponding to uload, ustore, ureturn is not legal !
